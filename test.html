<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thời khóa biểu</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    h1 { text-align: center; color: #333; }
    #datetime { text-align: center; margin-bottom: 20px; font-weight: bold; }
    .container { display: flex; gap: 20px; justify-content: center; }
    table { border-collapse: collapse; width: 100%; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #4a90e2; color: white; }
    td { cursor: pointer; }
    td:hover { background: #e0f7fa; }
    .status { margin-top: 20px; text-align: center; font-size: 18px; color: #d9534f; }
    .popup {
      display: none; position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%); background: white;
      padding: 20px; border: 2px solid #333; border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .popup button { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Thời khóa biểu</h1>
  <div id="datetime"></div>
  <div class="container">
    <div>
      <h2>Buổi sáng</h2>
      <table id="morning"></table>
    </div>
    <div>
      <h2>Buổi chiều</h2>
      <table id="afternoon"></table>
    </div>
  </div>
  <div class="status" id="status"></div>

  <div class="popup" id="popup">
    <div id="popupContent"></div>
    <button onclick="closePopup()">Đóng</button>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz04IeeS7Bw93cX2hWDwYX76VrHtb2ExNEQ0_4fx24hLDQcLCJSewTV13h-UUlGQh9p/exec";

    async function fetchData() {
      const res = await fetch(API_URL);
      const data = await res.json();
      renderTimetable(data);
      checkCurrentLesson(data);
    }

    function renderTimetable(data) {
      const morning = document.getElementById("morning");
      const afternoon = document.getElementById("afternoon");

      // Header
      let header = "<tr><th>Tiết</th><th>Thứ 2</th><th>Thứ 3</th><th>Thứ 4</th><th>Thứ 5</th><th>Thứ 6</th><th>Thứ 7</th></tr>";
      morning.innerHTML = header;
      afternoon.innerHTML = header;

      data.tkb.forEach(row => {
        let rowHtml = `<tr><td>${row["Buổi / Tiết"]}</td>`;
        for (let i = 2; i <= 7; i++) {
          let subject = row[`THỨ ${i}`] || "";
          rowHtml += `<td onclick="showPopup('${subject}', '${row["Mã tiết"]}')">${subject}</td>`;
        }
        rowHtml += "</tr>";
        if (row["Mã tiết"].startsWith("s")) morning.innerHTML += rowHtml;
        else afternoon.innerHTML += rowHtml;
      });
    }

    function showPopup(subject, code) {
      if (!subject) return;
      fetch(API_URL).then(res => res.json()).then(data => {
        let tiet = data.tiet[code];
        if (tiet) {
          document.getElementById("popupContent").innerHTML =
            `<b>${subject}</b><br>Giờ học: ${tiet.start} - ${tiet.end}`;
          document.getElementById("popup").style.display = "block";
        }
      });
    }

    function closePopup() {
      document.getElementById("popup").style.display = "none";
    }

    function checkCurrentLesson(data) {
      const now = new Date();
      const currentTime = now.getHours() + ":" + now.getMinutes();
      let status = "Đang ngoài giờ học";

      for (let code in data.tiet) {
        let { ten, start, end } = data.tiet[code];
        if (currentTime >= start && currentTime <= end) {
          status = `Hiện tại đang học: ${ten} (${code})`;
        }
      }
      document.getElementById("status").innerText = status;
    }

    function updateClock() {
      const now = new Date();
      document.getElementById("datetime").innerText =
        now.toLocaleDateString("vi-VN") + " " + now.toLocaleTimeString("vi-VN");
    }

    setInterval(updateClock, 1000);
    updateClock();
    fetchData();
  </script>
</body>
</html>
