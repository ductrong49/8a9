<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thời khóa biểu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; color: #333; }
    .datetime { text-align: center; margin-bottom: 10px; font-weight: bold; color: #0066cc; }
    .current-subject { text-align: center; margin-bottom: 20px; font-size: 18px; color: #cc0000; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #0066cc; color: white; }
    td { cursor: pointer; }
    td:hover { background: #e0f0ff; }
    .section-title { margin: 20px 0 10px; font-size: 20px; color: #0066cc; font-weight: bold; }
  </style>
</head>
<body>
  <h1>THỜI KHÓA BIỂU</h1>
  <div class="datetime" id="datetime"></div>
  <div class="current-subject" id="currentSubject">Đang kiểm tra môn học...</div>

  <div class="section-title">BUỔI SÁNG</div>
  <table>
    <thead>
      <tr>
        <th>Tiết</th>
        <th>Thứ 2</th>
        <th>Thứ 3</th>
        <th>Thứ 4</th>
        <th>Thứ 5</th>
        <th>Thứ 6</th>
        <th>Thứ 7</th>
      </tr>
    </thead>
    <tbody id="morning"></tbody>
  </table>

  <div class="section-title">BUỔI CHIỀU</div>
  <table>
    <thead>
      <tr>
        <th>Tiết</th>
        <th>Thứ 2</th>
        <th>Thứ 3</th>
        <th>Thứ 4</th>
        <th>Thứ 5</th>
        <th>Thứ 6</th>
        <th>Thứ 7</th>
      </tr>
    </thead>
    <tbody id="afternoon"></tbody>
  </table>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbz04IeeS7Bw93cX2hWDwYX76VrHtb2ExNEQ0_4fx24hLDQcLCJSewTV13h-UUlGQh9p/exec";

  let subjects = {};
  let periods = {};

  async function loadData() {
    try {
      let res = await fetch(API_URL);
      let data = await res.json();
      subjects = data.subjects;
      periods = data.periods;

      let tableMorning = document.getElementById("morning");
      let tableAfternoon = document.getElementById("afternoon");

      for (let pid in subjects) {
        let row = document.createElement("tr");
        let firstCell = document.createElement("td");
        firstCell.textContent = periods[pid] ? periods[pid].name : pid;
        row.appendChild(firstCell);

        ["THỨ 2","THỨ 3","THỨ 4","THỨ 5","THỨ 6","THỨ 7"].forEach(day=>{
          let cell = document.createElement("td");
          cell.textContent = subjects[pid][day] || "";
          if(cell.textContent){
            cell.onclick = ()=>showPopup(pid, subjects[pid][day], periods);
          }
          row.appendChild(cell);
        });

        if(pid.startsWith("s")) tableMorning.appendChild(row);
        else tableAfternoon.appendChild(row);
      }

      updateCurrentSubject(); // Cập nhật môn học hiện tại
      setInterval(updateCurrentSubject, 60000); // Kiểm tra lại mỗi phút
    } catch (e) {
      console.error("Không lấy được dữ liệu:", e);
    }
  }

  function showPopup(pid, subject, periods){
    if(!subject) return;
    let p = periods[pid];
    if(!p) return;
    alert(`Môn học: ${subject}\nTiết: ${p.name}\nThời gian: ${p.start} - ${p.end}`);
  }

  // Hiển thị ngày giờ hiện tại
  function updateDateTime(){
    let now = new Date();
    let options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit' };
    document.getElementById("datetime").textContent = now.toLocaleDateString("vi-VN", options);
  }
  setInterval(updateDateTime, 1000);
  updateDateTime();

  // Xác định môn học hiện tại
  function updateCurrentSubject(){
    let now = new Date();
    let dayIndex = now.getDay(); // 0=CN, 1=T2...
    let days = ["CN","THỨ 2","THỨ 3","THỨ 4","THỨ 5","THỨ 6","THỨ 7"];
    let today = days[dayIndex];
    let timeNow = now.toTimeString().slice(0,5); // HH:MM

    let found = false;
    for(let pid in periods){
      let p = periods[pid];
      if(p.start <= timeNow && timeNow <= p.end){
        let subject = subjects[pid] && subjects[pid][today] ? subjects[pid][today] : null;
        if(subject){
          document.getElementById("currentSubject").textContent =
            `Đang học: ${subject} – ${p.name} (${p.start} - ${p.end})`;
          found = true;
          break;
        }
      }
    }
    if(!found){
      document.getElementById("currentSubject").textContent = "Đang ngoài giờ học";
    }
  }

  loadData();
  </script>
</body>
</html>
