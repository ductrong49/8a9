<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Th·ªùi kh√≥a bi·ªÉu</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 20px; }
    h1 { text-align: center; color: #333; }
    #now { text-align: center; font-size: 18px; margin: 15px; font-weight: bold; color: #0077cc; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #0077cc; color: #fff; }
    .morning { background: #e0f7fa; }
    .afternoon { background: #fff9c4; }
    td.clickable { cursor: pointer; color: #0077cc; font-weight: bold; }
    td.clickable:hover { background: #d0ebff; }
    #popup { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
             background:#fff; border:2px solid #0077cc; padding:20px; border-radius:10px; 
             box-shadow:0 0 10px rgba(0,0,0,0.3); }
    #popup button { margin-top:10px; padding:5px 10px; background:#0077cc; color:#fff; border:none; border-radius:5px; }
  </style>
</head>
<body>
  <h1>üìö Th·ªùi kh√≥a bi·ªÉu</h1>
  <div id="now">ƒêang t·∫£i...</div>
  <h2>Bu·ªïi s√°ng</h2>
  <table id="morning"></table>
  <h2>Bu·ªïi chi·ªÅu</h2>
  <table id="afternoon"></table>

  <div id="popup">
    <div id="popup-content"></div>
    <button onclick="closePopup()">ƒê√≥ng</button>
  </div>

  <script>
    const url = "https://script.google.com/macros/s/AKfycbz04IeeS7Bw93cX2hWDwYX76VrHtb2ExNEQ0_4fx24hLDQcLCJSewTV13h-UUlGQh9p/exec";

    async function loadData() {
      const res = await fetch(url);
      const data = await res.json();
      buildTable(data.sheet1, data.sheet2);
      showNow(data.sheet1, data.sheet2);
      setInterval(() => showNow(data.sheet1, data.sheet2), 60000); // c·∫≠p nh·∫≠t m·ªói ph√∫t
    }

    function buildTable(sheet1, sheet2) {
      const header = sheet1[0];
      let morningHTML = "<tr>" + header.map(h => `<th>${h}</th>`).join("") + "</tr>";
      let afternoonHTML = "<tr>" + header.map(h => `<th>${h}</th>`).join("") + "</tr>";

      for (let i = 1; i < sheet1.length; i++) {
        let row = sheet1[i];
        let html = "<tr>";
        for (let j = 0; j < row.length; j++) {
          if (j > 1 && row[j]) {
            html += `<td class="clickable" onclick="showPopup('${row[0]}')">${row[j]}</td>`;
          } else {
            html += `<td>${row[j] || ""}</td>`;
          }
        }
        html += "</tr>";
        if (row[0].startsWith("s")) morningHTML += html;
        else afternoonHTML += html;
      }
      document.getElementById("morning").innerHTML = morningHTML;
      document.getElementById("afternoon").innerHTML = afternoonHTML;

      window.sheet2 = sheet2; // l∆∞u ƒë·ªÉ d√πng trong popup
    }

    function showPopup(maTiet) {
      const tiet = window.sheet2.find(r => r[0] === maTiet);
      if (tiet) {
        document.getElementById("popup-content").innerText = 
          `${tiet[1]}: ${tiet[2]} - ${tiet[3]}`;
        document.getElementById("popup").style.display = "block";
      }
    }

    function closePopup() {
      document.getElementById("popup").style.display = "none";
    }

    function showNow(sheet1, sheet2) {
      const now = new Date();
      const currentDay = now.getDay(); // CN=0
      const currentTime = now.toTimeString().substring(0,5);

      if (currentDay === 0) {
        document.getElementById("now").innerText = "H√¥m nay l√† Ch·ªß nh·∫≠t, kh√¥ng c√≥ ti·∫øt h·ªçc.";
        return;
      }

      let currentTiet = null;
      for (let i = 1; i < sheet2.length; i++) {
        const [ma, ten, start, end] = sheet2[i];
        if (start <= currentTime && currentTime <= end) {
          currentTiet = sheet2[i];
          break;
        }
      }

      if (!currentTiet) {
        document.getElementById("now").innerText = "ƒêang ngo√†i gi·ªù h·ªçc.";
        return;
      }

      const [maTiet, tenTiet, start, end] = currentTiet;
      const row = sheet1.find(r => r[0] === maTiet);
      const monHoc = row ? row[currentDay+1] : "Tr·ªëng";

      document.getElementById("now").innerText =
        `H√¥m nay: Th·ª© ${currentDay+1} | ƒêang h·ªçc: ${monHoc || "Tr·ªëng"} | ${tenTiet} (${start} - ${end})`;
    }

    loadData();
  </script>
</body>
</html>
