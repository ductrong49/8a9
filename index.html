<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Thời khóa biểu Lớp 8A9</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 10px;
  }
  h1 {
    text-align: center;
  }
  #schedule {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    overflow-x: auto;
  }
  .dayColumn {
    border: 1px solid #ccc;
    padding: 5px;
    min-width: 120px;
    margin-right: 10px;
    border-radius: 5px;
  }
  .dayHeader {
    font-weight: bold;
    text-align: center;
    margin-bottom: 10px;
  }
  .morning, .afternoon {
    margin-bottom: 10px;
  }
  .period {
    border: 1px solid #aaa;
    padding: 5px;
    margin: 3px 0;
    cursor: default;
  }
  .period.editable {
    cursor: pointer;
    background-color: #eef;
  }
  .monday { background-color: #f9c2c2; }
  .tuesday { background-color: #c2f9c2; }
  .wednesday { background-color: #c2d9f9; }
  .thursday { background-color: #f9f4c2; }
  .friday { background-color: #f9c2e6; }
  .saturday { background-color: #c2f4f9; }
  #lastUpdated {
    margin-top: 10px;
    font-style: italic;
    text-align: center;
    color: #555;
  }
  #loginSection, #adminSection {
    margin-top: 20px;
    text-align: center;
  }
  input[type="password"], input[type="text"] {
    padding: 5px;
    width: 220px;
    margin: 5px 0;
  }
  button {
    padding: 5px 15px;
    cursor: pointer;
  }
  #loginMsg {
    color: red;
    margin-top: 5px;
  }
  #tokenInput {
    width: 100%;
    box-sizing: border-box;
  }
</style>
</head>
<body>

<h1>Thời khóa biểu Lớp 8A9</h1>

<div id="lastUpdated"></div>

<div id="schedule">Đang tải thời khóa biểu...</div>

<div id="adminSection" style="display:none;">
  <h2>Admin chỉnh sửa</h2>
  <button id="saveBtn">Lưu thay đổi lên GitHub</button>
  <button id="logoutBtn">Đăng xuất</button>
  <div id="saveMsg" style="margin-top:10px;"></div>
</div>

<div id="loginSection">
  <h3>Đăng nhập admin</h3>
  <input type="password" id="adminPass" placeholder="Mật khẩu admin" /><br />
  <input type="text" id="tokenInput" placeholder="Nhập GitHub Personal Access Token" /><br />
  <button id="loginBtn">Đăng nhập</button>
  <div id="loginMsg"></div>
</div>

<script>
  // Cấu hình repo GitHub của bạn
  const GITHUB_OWNER = "ductrong49";
  const GITHUB_REPO = "8A9";
  const FILE_PATH = "data.json";
  const BRANCH = "main";

  const API_BASE = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FILE_PATH}`;
  const RAW_BASE = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${BRANCH}/${FILE_PATH}`;

  let scheduleData = null;
  let fileSHA = null;
  let isAdmin = false;
  let adminToken = "";

  const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
  const dayClasses = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];

  const scheduleDiv = document.getElementById("schedule");
  const lastUpdatedDiv = document.getElementById("lastUpdated");
  const loginSection = document.getElementById("loginSection");
  const adminSection = document.getElementById("adminSection");
  const loginMsg = document.getElementById("loginMsg");
  const saveMsg = document.getElementById("saveMsg");

  async function fetchSchedule() {
    scheduleDiv.textContent = "Đang tải thời khóa biểu...";
    try {
      const res = await fetch(RAW_BASE + "?t=" + new Date().getTime());
      if (!res.ok) throw new Error("Không lấy được dữ liệu từ GitHub");
      const data = await res.json();
      scheduleData = data;
      renderSchedule();
    } catch (e) {
      scheduleDiv.textContent = "Lỗi tải dữ liệu: " + e.message;
    }
  }

  async function fetchFileSHA() {
    const res = await fetch(API_BASE + `?ref=${BRANCH}`, {
      headers: { Authorization: `token ${adminToken}` }
    });
    if (!res.ok) throw new Error("Không lấy được SHA file data.json");
    const data = await res.json();
    return data.sha;
  }

  function renderSchedule() {
    scheduleDiv.innerHTML = "";
    days.forEach((day, i) => {
      const dayDiv = document.createElement("div");
      dayDiv.classList.add("dayColumn", dayClasses[i]);

      const header = document.createElement("div");
      header.classList.add("dayHeader");
      header.textContent = day;
      dayDiv.appendChild(header);

      // Buổi sáng
      const morningDiv = document.createElement("div");
      morningDiv.classList.add("morning");
      morningDiv.innerHTML = "<strong>Sáng</strong>";
      scheduleData.schedule[day].morning.forEach((subject, idx) => {
        const p = document.createElement("div");
        p.classList.add("period");
        if (isAdmin) p.classList.add("editable");
        p.dataset.day = day;
        p.dataset.session = "morning";
        p.dataset.index = idx;
        p.textContent = subject;
        if (isAdmin) {
          p.addEventListener("click", () => editSubject(p));
        }
        morningDiv.appendChild(p);
      });
      dayDiv.appendChild(morningDiv);

      // Buổi chiều
      const afternoonDiv = document.createElement("div");
      afternoonDiv.classList.add("afternoon");
      afternoonDiv.innerHTML = "<strong>Chiều</strong>";
      scheduleData.schedule[day].afternoon.forEach((subject, idx) => {
        const p = document.createElement("div");
        p.classList.add("period");
        if (isAdmin) p.classList.add("editable");
        p.dataset.day = day;
        p.dataset.session = "afternoon";
        p.dataset.index = idx;
        p.textContent = subject;
        if (isAdmin) {
          p.addEventListener("click", () => editSubject(p));
        }
        afternoonDiv.appendChild(p);
      });
      dayDiv.appendChild(afternoonDiv);

      scheduleDiv.appendChild(dayDiv);
    });

    const d = new Date(scheduleData.lastUpdated);
    lastUpdatedDiv.textContent = "Cập nhật lần cuối: " + d.toLocaleString("vi-VN");
  }

  function editSubject(element) {
    if (!isAdmin) return;
    const oldValue = element.textContent;
    const input = document.createElement("input");
    input.type = "text";
    input.value = oldValue;
    element.textContent = "";
    element.appendChild(input);
    input.focus();

    input.addEventListener("blur", () => {
      const newValue = input.value.trim() || oldValue;
      const day = element.dataset.day;
      const session = element.dataset.session;
      const idx = element.dataset.index;

      scheduleData.schedule[day][session][idx] = newValue;
      scheduleData.lastUpdated = new Date().toISOString();

      element.removeChild(input);
      element.textContent = newValue;

      const d = new Date(scheduleData.lastUpdated);
      lastUpdatedDiv.textContent = "Cập nhật lần cuối: " + d.toLocaleString("vi-VN");

      saveMsg.textContent = "";
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        input.blur();
      }
    });
  }

  async function saveToGitHub() {
    if (!adminToken) {
      saveMsg.style.color = "red";
      saveMsg.textContent = "Bạn chưa nhập token GitHub!";
      return;
    }
    saveMsg.style.color = "black";
    saveMsg.textContent = "Đang lưu dữ liệu lên GitHub...";
    try {
      if (!fileSHA) {
        fileSHA = await fetchFileSHA();
      }
      const contentBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(scheduleData, null, 2))));
      const res = await fetch(API_BASE, {
        method: "PUT",
        headers: {
          Authorization: `token ${adminToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Cập nhật thời khóa biểu ${new Date().toLocaleString()}`,
          content: contentBase64,
          sha: fileSHA,
          branch: BRANCH
        })
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.message || "Lỗi khi cập nhật file");
      }
      const result = await res.json();
      fileSHA = result.content.sha;
      saveMsg.style.color = "green";
      saveMsg.textContent = "Lưu dữ liệu thành công!";
    } catch (e) {
      saveMsg.style.color = "red";
      saveMsg.textContent = "Lỗi lưu dữ liệu: " + e.message;
    }
  }

  document.getElementById("loginBtn").addEventListener("click", () => {
    const pass = document.getElementById("adminPass").value;
    const token = document.getElementById("tokenInput").value.trim();

    if (pass === "admin123" && token) {
      isAdmin = true;
      adminToken = token;
      loginSection.style.display = "none";
      adminSection.style.display = "block";
      loginMsg.textContent = "";
      saveMsg.textContent = "";
      fetchFileSHA().then(sha => {
        fileSHA = sha;
      }).catch(() => {
        fileSHA = null;
      });
      renderSchedule();
    } else {
      loginMsg.textContent = "Mật khẩu hoặc token sai hoặc chưa nhập!";
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", () => {
    isAdmin = false;
    adminToken = "";
    loginSection.style.display = "block";
    adminSection.style.display = "none";
    saveMsg.textContent = "";
    renderSchedule();
  });

  document.getElementById("saveBtn").addEventListener("click", () => {
    saveToGitHub();
  });

  // Load dữ liệu lần đầu
  fetchSchedule();
</script>

</body>
</html>
