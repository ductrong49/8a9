<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THỜI KHÓA BIỂU LỚP 8A9 v1</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f4ff;
    margin: 0; padding: 0;
    color: #123b7a;
  }
  header {
    background: #c7d8ff;
    padding: 20px;
    text-align: center;
  }
  header h1 {
    margin: 0;
    font-size: 40px;
    color: #0f3c91;
  }
  #status {
    margin: 10px auto;
    max-width: 900px;
    text-align: center;
    font-weight: bold;
  }
  #updateDate {
    margin: 10px auto;
    max-width: 900px;
    text-align: center;
    font-style: italic;
    color: #555;
  }
  #loginSection {
    max-width: 900px;
    margin: 20px auto;
    text-align: center;
  }
  #loginSection input[type="password"] {
    padding: 8px;
    font-size: 16px;
  }
  #loginSection button {
    padding: 8px 16px;
    font-size: 16px;
    background: #0f3c91;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-left: 8px;
  }
  #timetableWrapper {
    max-width: 900px;
    margin: 0 auto 40px;
    overflow-x: auto;
    background: white;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  table {
    border-collapse: collapse;
    width: 100%;
    min-width: 700px;
  }
  th, td {
    border: 1px solid #d3dff9;
    text-align: center;
    padding: 10px 8px;
  }
  th {
    background-color: #a3c1ff;
    color: #0f3c91;
    font-weight: 700;
  }
  /* Các thứ trong tuần nền màu khác nhau */
  th:nth-child(2), td:nth-child(2) { background-color: #ffdae8; } /* Thứ 2,4,6 màu hồng nhạt */
  th:nth-child(4), td:nth-child(4) { background-color: #ffdae8; }
  th:nth-child(6), td:nth-child(6) { background-color: #ffdae8; }

  th:nth-child(3), td:nth-child(3) { background-color: #d4e4ff; } /* Thứ 3,5,7 màu xanh dương nhạt */
  th:nth-child(5), td:nth-child(5) { background-color: #d4e4ff; }
  th:nth-child(7), td:nth-child(7) { background-color: #d4e4ff; }

  td.session-header {
    background: #c7e3a4;
    font-weight: bold;
    text-align: left;
    padding-left: 14px;
    font-size: 16px;
  }
  td.editable {
    cursor: pointer;
  }
  td.editable[contenteditable="true"] {
    background-color: #fff8dc;
    border: 1px solid #f2a365;
  }
  button#logoutBtn {
    background: #b84c4c;
    margin-left: 10px;
  }
  #loginSection, #logoutSection {
    max-width: 900px;
    margin: 20px auto;
    text-align: center;
  }
</style>
</head>
<body>

<header>
  <h1>THỜI KHÓA BIỂU LỚP 8A9</h1>
</header>

<div id="status"></div>
<div id="updateDate"></div>

<div id="loginSection">
  <input type="password" id="passwordInput" placeholder="Nhập mật khẩu để chỉnh sửa" />
  <button id="loginBtn">Đăng nhập</button>
</div>

<div id="logoutSection" style="display:none;">
  <span>Đã đăng nhập với quyền chỉnh sửa.</span>
  <button id="logoutBtn">Đăng xuất</button>
</div>

<div id="timetableWrapper">
  <table id="timetable">
    <thead>
      <tr>
        <th>Buổi / Tiết</th>
        <th>Thứ 2</th>
        <th>Thứ 3</th>
        <th>Thứ 4</th>
        <th>Thứ 5</th>
        <th>Thứ 6</th>
        <th>Thứ 7</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- Tạo động bằng JS -->
    </tbody>
  </table>
</div>

<script>
(() => {
  const repoOwner = "ductrong49";
  const repoName = "8a9";
  const filePath = "tkb.json";
  const branch = "main";
  const githubToken = "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";
  const adminPassword = "Ductrong123";

  const statusDiv = document.getElementById("status");
  const updateDateDiv = document.getElementById("updateDate");
  const loginSection = document.getElementById("loginSection");
  const logoutSection = document.getElementById("logoutSection");
  const passwordInput = document.getElementById("passwordInput");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const tbody = document.getElementById("tbody");

  let timetableData = null;
  let fileSha = null;
  let isAdmin = false;

  // Hàm mã hóa base64 unicode đúng cách
  function base64EncodeUnicode(str) {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
      (match, p1) => String.fromCharCode('0x' + p1)));
  }

  // Hàm decode base64 unicode
  function base64DecodeUnicode(str) {
    return decodeURIComponent(atob(str).split('').map(c => {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
  }

  function showStatus(msg, color = "black") {
    statusDiv.textContent = msg;
    statusDiv.style.color = color;
  }

  // Lấy thông tin file từ GitHub
  async function fetchFile() {
    showStatus("Đang tải dữ liệu...");
    try {
      const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}?ref=${branch}`, {
        headers: { Authorization: "token " + githubToken }
      });
      if (!res.ok) throw new Error(`Lỗi khi lấy file: ${res.status} ${res.statusText}`);
      const json = await res.json();
      fileSha = json.sha;
      timetableData = JSON.parse(base64DecodeUnicode(json.content));
      if (!timetableData.MORNING || !timetableData.AFTERNOON) throw new Error("Dữ liệu không hợp lệ");
      renderTable();
      updateDateDiv.textContent = "Cập nhật lần cuối: " + new Date(json.git_url ? json.git_url : Date.now()).toLocaleString();
      showStatus("Tải dữ liệu thành công", "green");
    } catch (e) {
      showStatus(e.message, "red");
      timetableData = { MORNING: Array(5).fill(null).map(() => Array(6).fill("")), AFTERNOON: Array(5).fill(null).map(() => Array(6).fill("")) };
      renderTable();
    }
  }

  // Vẽ bảng thời khóa biểu
  function renderTable() {
    tbody.innerHTML = "";
    // Buổi sáng tiêu đề
    let tr = document.createElement("tr");
    let td = document.createElement("td");
    td.className = "session-header";
    td.textContent = "BUỔI SÁNG";
    td.colSpan = 7;
    tr.appendChild(td);
    tbody.appendChild(tr);
    // Buổi sáng 5 tiết
    for (let r = 0; r < 5; r++) {
      tr = document.createElement("tr");
      td = document.createElement("td");
      td.textContent = `Tiết ${r + 1}`;
      td.style.textAlign = "left";
      td.style.fontWeight = "bold";
      tr.appendChild(td);
      for (let c = 0; c < 6; c++) {
        const cell = document.createElement("td");
        cell.textContent = timetableData.MORNING[r][c] || "";
        if (isAdmin) {
          cell.contentEditable = "true";
          cell.classList.add("editable");
          cell.dataset.session = "MORNING";
          cell.dataset.r = r;
          cell.dataset.c = c;
          cell.style.backgroundColor = "#fff8dc";
          cell.style.border = "1px solid #f2a365";
          cell.addEventListener("input", () => {
            cell.classList.add("edited");
          });
        }
        tr.appendChild(cell);
      }
      tbody.appendChild(tr);
    }
    // Buổi chiều tiêu đề
    tr = document.createElement("tr");
    td = document.createElement("td");
    td.className = "session-header";
    td.textContent = "BUỔI CHIỀU";
    td.colSpan = 7;
    tr.appendChild(td);
    tbody.appendChild(tr);
    // Buổi chiều 5 tiết
    for (let r = 0; r < 5; r++) {
      tr = document.createElement("tr");
      td = document.createElement("td");
      td.textContent = `Tiết ${r + 1}`;
      td.style.textAlign = "left";
      td.style.fontWeight = "bold";
      tr.appendChild(td);
      for (let c = 0; c < 6; c++) {
        const cell = document.createElement("td");
        cell.textContent = timetableData.AFTERNOON[r][c] || "";
        if (isAdmin) {
          cell.contentEditable = "true";
          cell.classList.add("editable");
          cell.dataset.session = "AFTERNOON";
          cell.dataset.r = r;
          cell.dataset.c = c;
          cell.style.backgroundColor = "#fff8dc";
          cell.style.border = "1px solid #f2a365";
          cell.addEventListener("input", () => {
            cell.classList.add("edited");
          });
        }
        tr.appendChild(cell);
      }
      tbody.appendChild(tr);
    }
  }

  // Lưu dữ liệu lên GitHub
  async function saveFile() {
    showStatus("Đang lưu dữ liệu...");
    try {
      // Cập nhật dữ liệu từ các ô editable
      if (isAdmin) {
        const editableCells = tbody.querySelectorAll("td.editable");
        editableCells.forEach(cell => {
          const session = cell.dataset.session;
          const r = +cell.dataset.r;
          const c = +cell.dataset.c;
          if (!timetableData[session]) timetableData[session] = [];
          if (!timetableData[session][r]) timetableData[session][r] = [];
          timetableData[session][r][c] = cell.textContent.trim();
        });
      }

      // Cập nhật thời gian lần cuối
      timetableData.lastUpdated = new Date().toISOString();

      // Mã hóa nội dung
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(timetableData, null, 2))));

      // Gửi PUT lên GitHub
      const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
        method: "PUT",
        headers: {
          Authorization: "token " + githubToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Cập nhật thời khóa biểu từ web",
          content: content,
          sha: fileSha,
          branch: branch
        })
      });

      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`Lỗi khi lưu: ${res.status} ${res.statusText} - ${errText}`);
      }

      const resJson = await res.json();
      fileSha = resJson.content.sha;
      showStatus("Lưu thành công!", "green");
      updateDateDiv.textContent = "Cập nhật lần cuối: " + new Date(timetableData.lastUpdated).toLocaleString();
      renderTable();
    } catch (e) {
      showStatus(e.message, "red");
    }
  }

  // Xử lý đăng nhập
  loginBtn.addEventListener("click", () => {
    if (passwordInput.value === adminPassword) {
      isAdmin = true;
      loginSection.style.display = "none";
      logoutSection.style.display = "block";
      showStatus("Đã đăng nhập với quyền chỉnh sửa.", "green");
      renderTable();
    } else {
      showStatus("Mật khẩu không đúng!", "red");
    }
  });

  logoutBtn.addEventListener("click", () => {
    isAdmin = false;
    loginSection.style.display = "block";
    logoutSection.style.display = "none";
    showStatus("Đã đăng xuất.", "black");
    renderTable();
  });

  // Lưu dữ liệu khi rời trang hoặc thoát chỉnh sửa
  window.addEventListener("beforeunload", (e) => {
    if (isAdmin) {
      e.preventDefault();
      e.returnValue = "";
      // Lưu file (không chặn thoát)
      saveFile();
    }
  });

  // Ngoài ra có thể thêm nút lưu trực tiếp khi chỉnh sửa xong (ví dụ nhấn Ctrl+S)
  document.addEventListener("keydown", (e) => {
    if (isAdmin && (e.key === 's' || e.key === 'S') && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      saveFile();
    }
  });

  // Khởi động lần đầu
  fetchFile();
})();
</script>

</body>
</html>
